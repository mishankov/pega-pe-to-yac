name: New VM

# Controls when the workflow will run
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3

      # Runs a set of commands using the runners shell
      - name: Download Yandex Cloud CLI
        run: |
          curl https://raw.githubusercontent.com/Jokero/yandex-cloud-cli-install-for-ci/master/install.sh | bash
          source "/home/runner/.bashrc"
      
      - name: Check version
        run: ~/yandex-cloud/bin/yc -v

      - name: Show existing compute instances
        run: ~/yandex-cloud/bin/yc --token ${{ secrets.YC_TOKEN }} --cloud-id ${{ secrets.YC_CLOUD_ID }} --folder-id ${{ secrets.YC_FOLDER_ID }} compute instance list

      - name: Create cache dir
        run: mkdir -p cache

      - name: Generate new key pair if not exist
        # run: "[ -f $SSH_KEY ] || ssh-keygen -b 2048 -t rsa -f $SSH_KEY -q -N \"\""
        run: "ssh-keygen -b 2048 -t rsa -f ssh_key -q -N \"\""

      - name: Create Yandex.Cloud compute instance
        run: |
          ~/yandex-cloud/bin/yc \
            --token ${{ secrets.YC_TOKEN }} --cloud-id ${{ secrets.YC_CLOUD_ID }} --folder-id ${{ secrets.YC_FOLDER_ID }} \
            compute instance create \
            --name first-instance \
            --zone ru-central1-a \
            --public-ip \
            --create-boot-disk size=30G,image-folder-id=standard-images,image-family=centos-stream-8 \
            --preemptible \
            --core-fraction 50 \
            --memory 8 \
            --ssh-key $ssh_key.pub
      
      - name: Show existing compute instances again
        run: ~/yandex-cloud/bin/yc --token ${{ secrets.YC_TOKEN }} --cloud-id ${{ secrets.YC_CLOUD_ID }} --folder-id ${{ secrets.YC_FOLDER_ID }} compute instance list
      
      - name: Print new vm config to file
        run: |
          ~/yandex-cloud/bin/yc \
            --token ${{ secrets.YC_TOKEN }} --cloud-id ${{ secrets.YC_CLOUD_ID }} --folder-id ${{ secrets.YC_FOLDER_ID }} \
            compute instance get first-instance > cache/vmconfig.txt
        
      - name: Save address to cache
        run: "cat cache/vmconfig.txt | grep -v 'address: 10'  | grep ' address:' | tr -d ' address:' > cache/addr"